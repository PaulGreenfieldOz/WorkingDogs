
# FilterReads
FilterReads is a fast kMer-based filter that pulls out matching reads from WGS datasets. Each read is tiled into kMers, and these are then matched against a set of kMer filters. 
Reads with sufficient numbers/coverage of matching kMers are kept (or discarded).  

The kMer filters are simply sets of kMers tiled from a set of reference sequences, and are generated by BuildFilter. Some pre-built filters are available via the GHAP distribution (https://doi.org/10.4225/08/59f98560eba25).  

Any number of filters can be specified in a single run, and they can be inclusive or exclusive. Reads that pass through FilterReads must have enough kMer matches onto any one 
of the specified inclusive filters, and not have too many matches on any of the exclusive filters. Matches can be either exact (+f or -f)
or single-base mismatches can be allowed (+fz or -fz). Generating single-base variants of large filters is very memory-hungry, so in this case small 'seed' matches are used first, and full variant generation is only done if the first 
'seed' part of the kMer get an exact match. This behaviour can be controlled with the -seedlength (-sl) option. 
Small kMer filters are always fully turned into sets of variant kMers, and this behaviour can be forced for larger sets by setting '-seedlength' to zero. 
Seeded fuzzy matching is slower than exact matching as the kmer variants are generated on the fly (and cached).

Example 1 below was written to filter bacterial 16S sequences from mixed human gut wall samples. 
These samples were a mixture of human and microbial RNA/DNA and the filter pulled out the bacterial 16S while discarding the very similar human 18S and mitochondrial 16S sequences. 
Example 2 shows FilterReads being used as part of an incremental assembly pipeline, pulling out matches to a target genome from a metagenomic dataset. The matching reads were then assembled, and the resulting contigs used in the next FilterReads run to capture more of the reads matching onto the genome actually present in the metagenome.

Pairs of reads can be processed as pairs, with either both members of the pair being selected, or both reads being rejected. The '-bothinpair' option requires that both members of a pair meet the selection requirements, 
and if either of them fail, both the reads are deemed to have failed. This option can be used to focus in on the just the reads that come from a well-defined region. This option is equivalent to the previous '-pairs' option.
The -eitherinpair option will select both reads in a pair if either of them pass the filtering tests. This option can be used to 
extend a matching region and is the basis of incremental filtering. If neither -bothinpair or -eitherinpair are chosen, then every read file is processed separately and any read-pairing will be lost.

The -full option only allows a read to be regarded as matching if it gets kMer matches across its full length, even if the required identity 
is fairly low. This option gives better quality matches, avoiding reads where all the matches come from a small region at one end.

FilterReads is a command-line program with the following cryptic usage hint:  
```
FilterReads -r tag -t threads [-bothinpair] [-eitherinpair] [-matches] [-full] [-len minLen] [-s] [-qt minQual] [-o outputDir] [-fasta] [-discards] [+f|fz includeFilter minMatches[%|pct]] [-f|fz excludeFilter minMatches[%|pct]] readsFNs
```  

A typical run of FilterReads is…  
`
FilterReads -r 16S –t 8 –full -bothinpair –qt 30 +fz RefSeq16S_25.mer 50% W1_?.fastq  
`  
…which will filter whatever files match W1_?.fastq for those reads where at least 50% of their 25-mers 
can be found in RefSeq16S_25.mer (a 25-mer filter built from RefSeq16S). Matches are required at 
both ends of the read (-full), and the 25-mers are allowed to have single-base differences. 
The filtered reads will be written to something like W1_1_16S.fastq and W1_2_16S.fastq, with read-pairing maintained.  

More complex examples are:

1. `FilterReads -r 16S -t 8 +f current_prokMSA_unaligned_May2011_25.mer 10% -f Human_mitochondria_25.mer 20% -f human_18S_25.mer 20% GH_02d_ATCACG_R?.fastq`

2. `BuildFilter -k 25 -lcf Marinomonas_polaris_25.mer Marinomonas_polaris_GCF_900129155.1_IMG-taxon_2582581270_annotated_assembly_genomic.fna; 
FilterReads -r Marinomonas_polaris -t 24 -eitherinpair -len 90 -sl 0 -o c:\SeqTemp\Amoeba -full -qt 25 +fz Marinomonas_polaris_25.mer 66pct Amoeba\PCRFree\11957_C9CRGANXX_CGATGTTT_L008_R?_noRepeat.fastq.gz`

FilterReads -r tag [-t threads] [-bothinpair] [-eitherinpair] [-full] [-matches] [-len minLen] [-first nnnn] [-s] 
[-qt minQual] [-o outputDir] [-fasta] [-discards] [+/-lcf] [+f|fz includeFilter minMatches[%|pct]] [-f|fz excludeFilter minMatches[%|pct]] readsFNs 
The full set of FilterReads parameters is:

| Option/Parameter        | Description       |
| ------------- |-------------| 
| -r or -run *tag* |This tag is added to the end of each to-be-filtered file name to create the name of the file that will hold the filtered reads. e.g. `–r 16S W1_1.fastq --> W1_1_16S.fastq`| 
| -t or -threads *number_of_threads* | Number of parallel filtering threads. Default is 1. |  
| -bothinpair (-bip) | Pairs of files (typically R1 & R2) are processed together, and both reads from each pair must pass the filtering test before they can be written to their respective ‘filtered’ files. If either read in a pair doesn’t get enough inclusive (+f) matches, or gets too many exclusive matches (-f), both the reads will be dropped. |
| -eitherinpair (-eip) | Pairs of reads are processed together, and only one of the reads has to meet the selection criteria for both reads in the pair to be selected. |
| -first nnn | Stop filtering after this many reads have been selected/written. Used to sample very large sequence files. |
| -fasta | Forces the filtered reads to be written in FASTA format. Default is to write out the filtered reads in the same format as used for the unfiltered reads. |
| -qualTrim *minimum_qual_value* (-qt) | Tail-trims each read prior to filtering. Uses a sliding window to cut back the tails of reads until the specified quality level is reached. Default is no trimming. |
| -length *minimum_read_length* (-l)| Minimum read length (after qual-trimming). Reads short than this length will be dropped.  |
| -fulllength (-full) | Matching kMers must appear in both halves of the reads. Improves overall filtering accuracy at the expense of reads covering the end of the target region. Default is to say that reads can be accepted with enough matches at just one end. |
| -seedlength nn (-sl) | The length of the smaller seed kMers used for fuzzy matches with larger filter sets. -sd 0 will force all kMer variants to be generated during initialisation. |
| +f *includeFilter minMatches[% pct]* or +fz *includeFilter minMatches[% pct]* | Inclusive filter. Reads must have the specified number of matches onto the kMers in this filter. The required number of matches can be a fixed number, such as 100, or a percentage of the read length, such as 50%. The % character is a bit special in some scripting languages so you can use ‘pct’, as in 50pct.  Matches can be exact (+f) or single -base mismatches can be allowed (+fz). Any number of these filters can be specified, and a successful match on any one of them is enough to declare that the read is matching. |
| -f *excludeFilter minMatches[% pct]* or -fz *excludeFilter minMatches[% pct]* | Exclusive filter. Reads must not have more than the specified number of matches onto this filter. Any number of these filters can be specified, and a match on any of them is enough to declare that the read should be rejected. |
| -s | Search for matching file names in any subdirectories as well as in the current directory. Default is to only look for matching file names in the current directory.  |
| -matches | Writes out an alignment of matching kMers and reads. This option should only be used on small datasets!  |
| -discards | Save any reads that were dropped because they matched one of the exclusive filters. These reads are written to ‘_discards’ files. e.g. S1_270_reads_anonymous_R?_discards.fasta |
| *readsFNP*  | List of file names/patterns of reads to be filtered. e.g. S1_270_reads_anonymous_R?.fasta.gz |

FilterReads is written in C# and is provided pre-compiled for Windows and Linux (and can be built for macOS). The AOT versions of these code files 
are stand-alone and should not require the installation of any additional run-time libraries. Smaller framework-dependent (FD) code
files are also provided, and these need to have an appropriate .NET run-time installed. See https://learn.microsoft.com/en-gb/dotnet/core/install
for instructions. FilterReads is ‘installed’ simply by copying its code file to an appropriate directory on your system. 

You can compile FilterReads yourself using the `dotnet publish` command. You’ll need to have installed the appropriate .NET SDK (see https://learn.microsoft.com/en-us/dotnet/core/sdk).  
The FilterReads code itself is in Program.cs in this directory, and you'll also need to download the files
in WorkingDocsCoreLibrary. FilterReads can be built as 'frame-work dependent' code or as 
standalone code (AOT) with necessary run-time code linked into the FilterReads executable. The AOT code will run on systems that do not have the 
.NET run-time installed. AOT code generation is only supported from .NET7 onwards.

The type of executable produced by `dotnet publish` is controlled by the `PublishProfile` option. Profiles are held in the 
Properties/PublishProfiles directory, for both framework-dependent and AOT compilations. Small scripts are provided that will 
build FilterReads executables. The AOT builds have to be done on a system that is compatible with the intended execution targets as 
parts of the platform run-time are linked into the executables. Pre-built FilterReads code is provided for Windows and Linux, and 
.NET SDKs are available that will allow FilterReads to be built for both x64 and ARM macOS systems. The Linux code has been built on 
Ubuntu 20 (for glibc 2.31) and on Ubuntu 24 (glibc 2.39), and tested on Ubuntu 24 and SUSE LES 15.5. 

The command `dotnet publish ./FilterReads.csproj -c release /p:PublishProfile=Linux64DN8FDFolderProfile.pubxml` will build a
framework-dependent x64 Linux FilterReads executable, and other versions can be built by changing the name of the profile file in the 
publish command.
